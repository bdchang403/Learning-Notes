<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guide for setting up first Github Project</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta name="description"
        content="Step-by-step interactive guide to setting up Workload Identity Federation between GitHub and Google Cloud.">
</head>

<body>

    <button id="menu-toggle" class="menu-toggle" aria-label="Toggle Menu">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <div class="logo">Guide for setting up first Github Project</div>
        </div>
        <nav class="sidebar-nav">
            <a href="#github" class="nav-item">
                <span class="step-num">01</span> GitHub
            </a>
            <a href="#gcp-setup" class="nav-item">
                <span class="step-num">02</span> GCP Setup
            </a>
            <a href="#wif" class="nav-item">
                <span class="step-num">03</span> WIF Setup
            </a>
            <a href="#iam" class="nav-item">
                <span class="step-num">04</span> IAM Roles
            </a>
            <a href="#artifact" class="nav-item">
                <span class="step-num">05</span> Artifacts
            </a>
            <a href="#actions" class="nav-item">
                <span class="step-num">06</span> Actions
            </a>
            <a href="#cloudrun" class="nav-item">
                <span class="step-num">07</span> Cloud Run
            </a>
            <a href="#troubleshoot" class="nav-item">
                <span class="step-num">08</span> Errors
            </a>
            <a href="#lessons" class="nav-item">
                <span class="step-num">09</span> Lessons
            </a>
        </nav>
    </aside>

    <div class="main-content">
        <header class="hero">
            <div class="container">
                <h1>Secure CI/CD with Github Action and Google Cloud</h1>

                <div class="learning-intro">
                    <div class="intro-block">
                        <h3>Learning Objectives</h3>
                        <ul>
                            <li><span class="highlight-icon">✓</span> Configure a secure connection between GitHub and
                                Google Cloud.</li>
                            <li><span class="highlight-icon">✓</span> Implement "Keyless" authentication using Workload
                                Identity Federation.</li>
                            <li><span class="highlight-icon">✓</span> Automate container deployment to Cloud Run.</li>
                        </ul>
                    </div>

                    <div class="intro-block">
                        <h3>Rationale</h3>
                        <p>Google Cloud Platform (GCP) provides scalable infrastructure and advanced security features.
                            By integrating GitHub Actions with Google Cloud, we can automate the delivery of our
                            applications using industry-standard DevOps practices, ensuring reliability and speed
                            without compromising security.</p>
                    </div>
                </div>
            </div>
        </header>

        <main class="container">

            <!-- SECTION 1: GITHUB -->
            <section id="github" class="step-section">
                <div class="step-header">
                    <h2>1. Create GitHub Repository</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">Why? We need a place to store our code and the automation workflow
                            configuration.</div>
                    </div>
                </div>
                <div class="step-content">
                    <p>Start by creating a new repository on GitHub.</p>
                    <ol>
                        <li>Click <strong>+</strong> > <strong>New repository</strong>.</li>
                        <li>Name: <code>gcp-wif-demo</code>.</li>
                        <li>Visibility: <strong>Public</strong> or <strong>Private</strong>.</li>
                        <li>Initialize with a <strong>README</strong>.</li>
                    </ol>
                    <div class="image-wrapper">
                        <img src="images/github_new_repo_ui.png" alt="GitHub New Repo UI">
                        <p class="caption">Create Repository Page</p>
                    </div>
                </div>
            </section>

            <!-- SECTION 2: GCP SETUP -->
            <section id="gcp-setup" class="step-section">
                <div class="step-header">
                    <h2>2. Google Cloud Setup</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">Why? We need to tell Google Cloud to activate the specific services (APIs)
                            we
                            plan to use, like IAM and Artifact Registry.</div>
                    </div>
                </div>
                <div class="step-content">
                    <p>Set up your environment variables to make copy-pasting easier.</p>
                    <div class="code-block">
                        <pre><code class="language-bash">export PROJECT_ID="your-project-id"
export REGION="us-central1"
export REPO_NAME="gcp-wif-demo"
export USER_NAME="your-github-username"</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>

                    <p>Enable the required APIs:</p>
                    <div class="code-block">
                        <pre><code class="language-bash">gcloud services enable iam.googleapis.com \
    cloudresourcemanager.googleapis.com \
    iamcredentials.googleapis.com \
    artifactregistry.googleapis.com \
    --project="${PROJECT_ID}"</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>
                </div>
            </section>

            <!-- SECTION 3: WIF -->
            <section id="wif" class="step-section">
                <div class="step-header">
                    <h2>3. Workload Identity Federation</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">Required because: This establishes a "trust relationship" so Google Cloud
                            believes GitHub is a legitimate identity provider. No keys needed!</div>
                    </div>
                </div>
                <div class="step-content">
                    <p>Create a <strong>Pool</strong> to organize your external identities.</p>
                    <div class="code-block">
                        <pre><code class="language-bash">gcloud iam workload-identity-pools create "github-pool" \
  --project="${PROJECT_ID}" \
  --location="global" \
  --display-name="GitHub Actions Pool"</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>

                    <div class="image-wrapper">
                        <img src="images/gcp_wif_pool_ui.png" alt="WIF Pool UI">
                    </div>

                    <p>Create a <strong>Provider</strong> to trust GitHub's OIDC tokens.</p>
                    <div class="code-block">
                        <pre><code class="language-bash">gcloud iam workload-identity-pools providers create-oidc "github-provider" \
  --project="${PROJECT_ID}" \
  --location="global" \
  --workload-identity-pool="github-pool" \
  --display-name="GitHub Provider" \
  --attribute-mapping="google.subject=assertion.sub,attribute.actor=assertion.actor,attribute.repository=assertion.repository" \
  --issuer-uri="https://token.actions.githubusercontent.com"</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>
                </div>
            </section>

            <!-- SECTION 4: IAM -->
            <section id="iam" class="step-section">
                <div class="step-header">
                    <h2>4. Service Account & IAM</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">Why? The "Service Account" is the actual GCP user that performs the work
                            (like
                            pushing a docker image). We give GitHub permission to "act as" this user.</div>
                    </div>
                </div>
                <div class="step-content">
                    <p>Create the Service Account:</p>
                    <div class="code-block">
                        <pre><code class="language-bash">export SERVICE_ACCOUNT="github-actions-sa"

gcloud iam service-accounts create "${SERVICE_ACCOUNT}" \
  --project="${PROJECT_ID}" \
  --display-name="GitHub Actions Service Account"</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>

                    <p>Grant permission to write to Artifact Registry:</p>
                    <div class="code-block">
                        <pre><code class="language-bash">gcloud projects add-iam-policy-binding "${PROJECT_ID}" \
  --member="serviceAccount:${SERVICE_ACCOUNT}@${PROJECT_ID}.iam.gserviceaccount.com" \
  --role="roles/artifactregistry.writer"</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>

                    <p><strong>Crucial Step:</strong> Allow your specific GitHub repo to impersonate this Service
                        Account.
                    </p>
                    <div class="code-block">
                        <pre><code class="language-bash">gcloud iam service-accounts add-iam-policy-binding "${SERVICE_ACCOUNT}@${PROJECT_ID}.iam.gserviceaccount.com" \
  --project="${PROJECT_ID}" \
  --role="roles/iam.workloadIdentityUser" \
  --member="principalSet://iam.googleapis.com/projects/$(gcloud projects describe ${PROJECT_ID} --format='value(projectNumber)')/locations/global/workloadIdentityPools/github-pool/attribute.repository/${USER_NAME}/${REPO_NAME}"</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>
                </div>
            </section>

            <!-- SECTION 5: ARTIFACT REGISTRY -->
            <section id="artifact" class="step-section">
                <div class="step-header">
                    <h2>5. Artifact Registry</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">Why? We need a private, secure place to store our Docker container images,
                            similar to Docker Hub but inside Google Cloud.</div>
                    </div>
                </div>
                <div class="step-content">
                    <p>Create the Docker repository:</p>
                    <div class="code-block">
                        <pre><code class="language-bash">export AR_REPO="my-docker-repo"

gcloud artifacts repositories create "${AR_REPO}" \
  --project="${PROJECT_ID}" \
  --location="${REGION}" \
  --repository-format=docker \
  --description="Docker repository for GitHub Actions"</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>
                    <div class="image-wrapper">
                        <img src="images/gcp_artifact_registry_ui.png" alt="Artifact Registry UI">
                    </div>
                </div>
            </section>

            <!-- SECTION 6: ACTIONS -->
            <section id="actions" class="step-section">
                <div class="step-header">
                    <h2>6. GitHub Actions Workflow</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">Why? This YAML file tells GitHub *exactly* what steps to run automatically
                            when
                            you push code.</div>
                    </div>
                </div>
                <div class="step-content">
                    <p>Create <code>.github/workflows/deploy.yaml</code> in your repo:</p>
                    <div class="code-block">
                        <pre><code class="language-yaml">name: Build and Push to GCP

on:
  push:
    branches: [ "main" ]

env:
  PROJECT_ID: 'your-project-id'
  REGION: 'us-central1'
  GAR_LOCATION: 'us-central1-docker.pkg.dev/your-project-id/my-docker-repo'
  SERVICE_ACCOUNT: 'github-actions-sa@your-project-id.iam.gserviceaccount.com'
  WORKLOAD_IDENTITY_PROVIDER: 'projects/123456789/locations/global/workloadIdentityPools/github-pool/providers/github-provider'

jobs:
  build-push:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write' # Required for WIF

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ env.WORKLOAD_IDENTITY_PROVIDER }}'
          service_account: '${{ env.SERVICE_ACCOUNT }}'

      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: Docker Auth
        run: |-
          gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Build and Push Container
        run: |-
          docker build -t "${{ env.GAR_LOCATION }}/my-app:${{ github.sha }}" .
          docker push "${{ env.GAR_LOCATION }}/my-app:${{ github.sha }}"</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>
                </div>
            </section>

            <!-- SECTION 7: CLOUD RUN -->
            <section id="cloudrun" class="step-section">
                <div class="step-header">
                    <h2>7. Deploy to Cloud Run</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">Why? Cloud Run is "serverless". It takes your Docker container and runs it
                            on a
                            URL instantly without you managing servers.</div>
                    </div>
                </div>
                <div class="step-content">
                    <p>Update your workflow file to add the deploy step:</p>
                    <div class="code-block">
                        <pre><code class="language-yaml">      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: my-app-service
          region: ${{ env.REGION }}
          image: ${{ env.GAR_LOCATION }}/my-app:${{ github.sha }}
          flags: '--allow-unauthenticated'</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>
                    <p><strong>To Kick-start:</strong> Commit and push these changes to your <code>main</code> branch.
                        Go to
                        the <strong>Actions</strong> tab in GitHub to watch it fly!</p>
                </div>
            </section>

            <!-- SECTION 8: TROUBLESHOOTING -->
            <section id="troubleshoot" class="step-section">
                <div class="step-header">
                    <h2>8. Top 10 Common Errors</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">First deployments fail 90% of the time due to permission logic. Here is how
                            to
                            fix the most common ones.</div>
                    </div>
                </div>
                <div class="step-content">
                    <details class="faq-item">
                        <summary><strong>1. Container failed to start (PORT 8080)</strong></summary>
                        <p><strong>Cause:</strong> Your app isn't listening on the environment variable
                            <code>$PORT</code>
                            (default 8080). <br><strong>Fix:</strong> Change your code to listen on
                            <code>process.env.PORT</code> instead of a hardcoded 3000.
                        </p>
                    </details>

                    <details class="faq-item">
                        <summary><strong>2. Permission 'run.admin' missing</strong></summary>
                        <p><strong>Fix:</strong> Give the Service Account the role:
                            <br><code>gcloud projects add-iam-policy-binding ... --role="roles/run.admin"</code>
                        </p>
                    </details>

                    <details class="faq-item">
                        <summary><strong>3. Permission 'iam.serviceAccountUser' missing</strong></summary>
                        <p><strong>Fix:</strong> The Service Account needs permission to "act as" itself.
                            <br><code>gcloud projects add-iam-policy-binding ... --role="roles/iam.serviceAccountUser"</code>
                        </p>
                    </details>

                    <details class="faq-item">
                        <summary><strong>4. Subject Issuer Mismatch</strong></summary>
                        <p><strong>Cause:</strong> Typo in the Workload Identity Federation mapping.
                            <br><strong>Fix:</strong> Check if your <code>repo:user/repo</code> casing matches exactly.
                        </p>
                    </details>

                    <details class="faq-item">
                        <summary><strong>5. Permission 'artifactregistry.writer' missing</strong></summary>
                        <p><strong>Fix:</strong> Ensure SA has <strong>Artifact Registry Writer</strong> role.</p>
                    </details>

                    <details class="faq-item">
                        <summary><strong>6. Org Policy Restricted</strong></summary>
                        <p><strong>Cause:</strong> Your company blocks public (unauthenticated) sites.
                            <br><strong>Fix:</strong> Remove <code>--allow-unauthenticated</code> or ask Admin.
                        </p>
                    </details>

                    <details class="faq-item">
                        <summary><strong>7. Region Mismatch</strong></summary>
                        <p><strong>Cause:</strong> Artifact in <code>us-east1</code> but deploying to
                            <code>us-central1</code>.
                        </p>
                    </details>

                    <details class="faq-item">
                        <summary><strong>8. API not enabled</strong></summary>
                        <p><strong>Fix:</strong> Run <code>gcloud services enable run.googleapis.com</code>.</p>
                    </details>

                    <details class="faq-item">
                        <summary><strong>9. GitHub Secrets Typos</strong></summary>
                        <p><strong>Tip:</strong> Check for accidental spaces when pasting secrets.</p>
                    </details>

                    <details class="faq-item">
                        <summary><strong>10. Docker Context Error</strong></summary>
                        <p><strong>Cause:</strong> <code>COPY . .</code> failing? Check your <code>.dockerignore</code>
                            file.</p>
                    </details>
                </div>
            </section>

            <!-- SECTION 9: LESSONS LEARNED -->
            <section id="lessons" class="step-section">
                <div class="step-header">
                    <h2>9. CI/CD & Testing Lessons Learned</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">Key learnings and solutions encountered while setting up the pipeline.
                        </div>
                    </div>
                </div>
                <div class="step-content">
                    <p>This section summarizes key learnings and solutions encountered while setting up a containerized
                        CI pipeline with GitHub Actions, Docker, and Karate.</p>

                    <h3>1. Docker Build Arguments and Secrets</h3>
                    <p><strong>Issue:</strong> Passing secrets as build arguments to <code>docker build</code> via shell
                        commands is prone to errors (e.g., <code>docker buildx build requires 1 argument</code>) due to
                        quoting and shell expansion.</p>
                    <p><strong>Solution:</strong> Use the official <code>docker/build-push-action</code>. It handles
                        secret injection safely and correctly parses arguments.</p>
                    <div class="code-block">
                        <pre><code class="language-yaml">- name: Build App Image
  uses: docker/build-push-action@v5
  with:
    context: .
    load: true # Keeps image available for subsequent steps
    build-args: |
      REACT_APP_GOOGLE_API_KEY=${{ secrets.REACT_APP_GOOGLE_API_KEY }}</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>

                    <h3>2. GitHub Environments</h3>
                    <p><strong>Issue:</strong> Secrets defined in a specific GitHub Environment (e.g., <code>CI</code>)
                        are not accessible to the workflow job unless the job explicitly references that environment.
                    </p>
                    <p><strong>Solution:</strong> Add the <code>environment</code> property to the job configuration.
                    </p>
                    <div class="code-block">
                        <pre><code class="language-yaml">jobs:
  test:
    environment: CI
    steps:
      ...</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>

                    <h3>3. Java Version Compatibility</h3>
                    <p><strong>Issue:</strong> Tools may have specific Java requirements that differ from the project
                        default. Karate 1.5.0+ requires Java 17, while the project might be on Java 11.</p>
                    <p><strong>Solution:</strong> Explicitly set the Java version in both the CI environment
                        (<code>actions/setup-java</code>) and the Maven configuration
                        (<code>maven-compiler-plugin</code>).</p>
                    <div class="code-block">
                        <pre><code class="language-yaml">- uses: actions/setup-java@v4
  with:
    java-version: '17'</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>

                    <h3>4. Testing with Restricted API Keys</h3>
                    <p><strong>Issue:</strong> Frontend API keys often have "Referrer Restrictions" (e.g., allow
                        <code>localhost:3000</code>).</p>
                    <ul>
                        <li><strong>Problem A:</strong> Direct API calls (backend-style) from tests lack the
                            <code>Referer</code> header and fail with <code>REQUEST_DENIED</code>.</li>
                        <li><strong>Problem B:</strong> Some Google Web Services (Places/Directions Web Service)
                            strictly reject frontend keys regardless of headers.</li>
                    </ul>
                    <p><strong>Solutions:</strong></p>
                    <ul>
                        <li><strong>Add Headers:</strong> For permitted APIs, add the header in the test background:
                            <code>* header Referer = 'http://localhost:3000/'</code>.</li>
                        <li><strong>Ignore Invalid Tests:</strong> If the key is strictly frontend-only, do not run
                            direct backend API tests. Use <code>@ignore</code> tags.</li>
                    </ul>

                    <h3>5. Headless Chrome Stability (UI Tests)</h3>
                    <p><strong>Issue:</strong> UI tests that pass locally often fail in headless CI environments due to
                        race conditions or rendering differences.</p>
                    <p><strong>Solutions:</strong></p>
                    <ul>
                        <li><strong>Explicit Waits:</strong> Never assume an element is ready. Use
                            <code>waitFor('#id')</code> or <code>waitFor("//xpath")</code>.</li>
                        <li><strong>Robust Selectors:</strong> Material UI and other frameworks often nest text.
                            <ul>
                                <li><em>Bad:</em> <code>//button[text()='Clear']</code> (Fails if text is in a
                                    <code>&lt;span&gt;</code>)</li>
                                <li><em>Good:</em> <code>//button[contains(., 'Clear')]</code> (Checks text content of
                                    element and children)</li>
                            </ul>
                        </li>
                        <li><strong>Mock Blocking functions:</strong> <code>window.alert</code> can block the execution
                            thread in headless mode. Overwrite it to prevent hangs if an error occurs.
                            <ul>
                                <li><em>Karate Example:</em> <code>* script("window.alert = function(){}")</code></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </section>

        </main>

        <footer>
            <p>&copy; 2024 Secure CI/CD Guide. Generated by Antigravity.</p>
        </footer>
    </div>

    <script src="script.js"></script>
</body>

</html>