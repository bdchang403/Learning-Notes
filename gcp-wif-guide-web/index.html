<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full Stack CI/CD Guide: Local to Cloud</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta name="description"
        content="Step-by-step interactive guide: Local React development, robust CI testing, and secure Keyless Google Cloud deployment.">
</head>

<body>

    <button id="menu-toggle" class="menu-toggle" aria-label="Toggle Menu">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <div class="logo">Full Stack CI/CD Guide</div>
        </div>
        <nav class="sidebar-nav">

            <div class="nav-section-header">Phase 1: Local Readiness</div>
            <a href="#github" class="nav-item">
                <span class="step-num">01</span> GitHub Repo
            </a>
            <a href="#blank-page" class="nav-item">
                <span class="step-num">02</span> Local Pitfalls
            </a>
            <a href="#ui-tests" class="nav-item">
                <span class="step-num">03</span> UI Tests
            </a>
            <a href="#api-keys" class="nav-item">
                <span class="step-num">04</span> API Keys
            </a>

            <div class="nav-section-header">Phase 2: Cloud Setup</div>
            <a href="#gcp-setup" class="nav-item">
                <span class="step-num">05</span> GCP Setup
            </a>
            <a href="#wif" class="nav-item">
                <span class="step-num">06</span> WIF Setup
            </a>
            <a href="#iam" class="nav-item">
                <span class="step-num">07</span> IAM Roles
            </a>
            <a href="#artifact" class="nav-item">
                <span class="step-num">08</span> Artifact Registry
            </a>

            <div class="nav-section-header">Phase 3: CI/CD Pipeline</div>
            <a href="#docker-secrets" class="nav-item">
                <span class="step-num">09</span> Docker Secrets
            </a>
            <a href="#java-compat" class="nav-item">
                <span class="step-num">10</span> Java Compat
            </a>
            <a href="#github-env" class="nav-item">
                <span class="step-num">11</span> Github Env
            </a>
            <a href="#actions" class="nav-item">
                <span class="step-num">12</span> Actions Content
            </a>
            <a href="#cloudrun" class="nav-item">
                <span class="step-num">13</span> Cloud Run
            </a>

            <div class="nav-section-header">Phase 4: Advanced</div>
            <a href="#self-hosted" class="nav-item">
                <span class="step-num">14</span> Runners
            </a>

            <div class="nav-section-header">Appendix</div>
            <a href="#troubleshoot" class="nav-item">
                <span class="step-num">15</span> Common Errors
            </a>
        </nav>
    </aside>

    <div class="main-content">
        <header class="hero">
            <div class="container">
                <h1>From Local React to Cloud Run</h1>

                <div class="learning-intro">
                    <div class="intro-block">
                        <h3>Learning Objectives</h3>
                        <li><span class="highlight-icon">✓</span> Debug and fix common local development issues (Ports,
                            IPv6, Imports).</li>
                        <li><span class="highlight-icon">✓</span> Configure robust headless UI tests for CI
                            environments.</li>
                        <li><span class="highlight-icon">✓</span> Configure a secure connection between GitHub and
                            Google Cloud.</li>
                        <li><span class="highlight-icon">✓</span> Implement "Keyless" authentication using Workload
                            Identity Federation.</li>
                        <li><span class="highlight-icon">✓</span> Automate container deployment to Cloud Run.</li>
                    </div>

                    <div class="intro-block">
                        <h3>Rationale</h3>
                        <p>Google Cloud Platform (GCP) provides scalable infrastructure and advanced security features.
                            True reliability starts locally. This guide covers the full journey: fixing local React
                            "blank pages", handling API keys safely, and orchestrating a secure, keyless deployment
                            pipeline using industry-standard DevOps practices.</p>
                    </div>
                </div>
            </div>
        </header>

        <main class="container">

            <!-- PHASE 1: LOCAL READINESS -->

            <!-- SECTION 1: GITHUB -->
            <section id="github" class="step-section">
                <div class="step-header">
                    <h2>1. Create GitHub Repository</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">Why? We need a place to store our code and the automation workflow
                            configuration.</div>
                    </div>
                </div>
                <div class="step-content">
                    <p>Start by creating a new repository on GitHub.</p>
                    <ol>
                        <li>Click <strong>+</strong> > <strong>New repository</strong>.</li>
                        <li>Name: <code>gcp-wif-demo</code>.</li>
                        <li>Visibility: <strong>Public</strong> or <strong>Private</strong>.</li>
                        <li>Initialize with a <strong>README</strong>.</li>
                    </ol>
                    <div class="image-wrapper">
                        <img src="images/github_new_repo_ui.png" alt="GitHub New Repo UI">
                        <p class="caption">Create Repository Page</p>
                    </div>
                </div>
            </section>

            <!-- SECTION 2: BLANK PAGE (Was 13/5) -->
            <section id="blank-page" class="step-section">
                <div class="step-header">
                    <h2>2. Local Development Pitfalls</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">Common issues when running React/Vite locally.</div>
                    </div>
                </div>
                <div class="step-content">
                    <details class="faq-item">
                        <summary><strong>1. The "Default Port" Trap</strong></summary>
                        <div class="faq-body">
                            <p><strong>Scenario:</strong> You launch your app, but `localhost:5173` refuses to connect.
                                You notice the terminal says it's running on `localhost:5174`.</p>
                            <p><strong>Why it happens:</strong> Vite (and many other tools) defaults to port 5173. If
                                that port is in use (e.g., by a "zombie" process from a previous run), it silently
                                increments to the next available port.</p>
                            <p><strong>The Fix:</strong> Enforce strict port usage in <code>vite.config.js</code>. This
                                forces the server to crash rather than switch ports, alerting you to the issue
                                immediately.</p>
                            <p>Code: <code>server: { port: 5173, strictPort: true }</code></p>
                        </div>
                    </details>

                    <details class="faq-item">
                        <summary><strong>2. The 20-Second Delay (IPv6 vs IPv4)</strong></summary>
                        <div class="faq-body">
                            <p><strong>Scenario:</strong> The app loads, but it takes exactly 20 seconds of a white
                                screen before anything appears.</p>
                            <p><strong>Why it happens:</strong> Node.js often prefers IPv6 resolution (`::1`) for
                                `localhost`. However, dev servers usually listen on IPv4 (`127.0.0.1`). The browser
                                tries IPv6, waits for the timeout (20s), and then falls back to IPv4.</p>
                            <p><strong>The Fix:</strong> Explicitly bind the server to the IPv4 loopback address in
                                <code>vite.config.js</code>.</p>
                            <p>Code: <code>server: { host: '127.0.0.1' }</code></p>
                        </div>
                    </details>

                    <details class="faq-item">
                        <summary><strong>3. The "Silent Crash" (Static Import Errors)</strong></summary>
                        <div class="faq-body">
                            <p><strong>Scenario:</strong> You see a blank white screen. There are NO errors in the
                                browser console. The Refresh button does nothing.</p>
                            <p><strong>Why it happens:</strong> If you have a syntax error or a typo in a top-level
                                `import` statement, the JavaScript engine fails to parse the file before React even
                                starts. Because it happens at the parsing level, generic Error Boundaries cannot catch
                                it.</p>
                            <p><strong>The Fix:</strong> Run <code>npm run build</code> in your terminal. The build
                                process (using `tsc` or `vite build`) scans all files for static validity and will print
                                the exact file and line number of the bad import.</p>
                        </div>
                    </details>

                    <details class="faq-item">
                        <summary><strong>4. The "React Crash" (Runtime Errors)</strong></summary>
                        <div class="faq-body">
                            <p><strong>Scenario:</strong> The app loads briefly, then turns white. The console shows a
                                red React error stack trace.</p>
                            <p><strong>Why it happens:</strong> An unhandled JavaScript exception occurred during
                                rendering (e.g., `cannot read property of undefined`). In React, if a component throws
                                an error, the entire component tree unmounts by default to protect data integrity.</p>
                            <p><strong>The Fix:</strong> Wrap your main specific component (or the entire App) in a
                                <strong>Global Error Boundary</strong>. This catches the crash and displays a "Something
                                went wrong" UI instead of a blank screen.</p>
                        </div>
                    </details>

                    <details class="faq-item">
                        <summary><strong>5. The "Nuclear Option" (Isolating the Problem)</strong></summary>
                        <div class="faq-body">
                            <p><strong>Scenario:</strong> You are stuck. You don't know if it's the network, the
                                browser, React, or your code.</p>
                            <p><strong>The Technique:</strong> Delete everything in `main.jsx` and replace it with a
                                single line: <code>document.body.innerHTML = "<h1>IT WORKS</h1>";</code>.</p>
                            <p><strong>The Logic:</strong> If "IT WORKS" appears, your server, browser, and network are
                                fine; the issue is definitely in your React code. If it doesn't appear, your environment
                                is broken (e.g., port blocking, wrong URL).</p>
                        </div>
                    </details>

                    <details class="faq-item">
                        <summary><strong>6. High Severity Vulnerabilities (npm audit)</strong></summary>
                        <div class="faq-body">
                            <p><strong>Scenario:</strong> Your CI pipeline fails because `npm audit` reports "High
                                Severity" vulnerabilities, but they are in libraries you don't use directly (nested
                                dependencies).</p>
                            <p><strong>Why it happens:</strong> A library like `react-scripts` might rely on an old
                                version of `postcss`. You can't upgrade `postcss` directly because you didn't install
                                it.</p>
                            <p><strong>The Fix:</strong> Use the <code>overrides</code> field in
                                <code>package.json</code>. This forces `npm` to replace the vulnerable version with a
                                secure one across the entire dependency tree.</p>
                            <div class="code-block">
                                <pre><code class="language-json">"overrides": {
  "nth-check": "^2.0.1",
  "postcss": "^8.4.31"
}</code></pre>
                            </div>
                        </div>
                    </details>
                </div>
            </section>

            <!-- SECTION 3: UI TESTS (Was 12/2) -->
            <section id="ui-tests" class="step-section">
                <div class="step-header">
                    <h2>3. Headless Chrome Stability</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">Making UI tests robust in headless CI.</div>
                    </div>
                </div>
                <div class="step-content">
                    <p><strong>Issue:</strong> UI tests that pass locally often fail in headless CI environments due to
                        race conditions or rendering differences.</p>
                    <p><strong>Symptoms:</strong> The test report shows random failures only in CI. Screenshots taken
                        during failure might show:</p>
                    <ul>
                        <li>A blank page (the element hasn't loaded yet).</li>
                        <li>A different element being clicked because the intended one wasn't ready.</li>
                    </ul>
                    <p>Logs often show <code>js.lang.RuntimeException: js eval failed</code> or timeout errors.</p>
                    <p><strong>Solutions:</strong></p>
                    <ul>
                        <li><strong>Explicit Waits:</strong> Never assume an element is ready. Use
                            <code>waitFor('#id')</code> or <code>waitFor("//xpath")</code>.
                        </li>
                        <li><strong>Robust Selectors:</strong> Material UI and other frameworks often nest text.
                            <ul>
                                <li><em>Bad:</em> <code>//button[text()='Clear']</code> (Fails if text is in a
                                    <code>&lt;span&gt;</code>)
                                </li>
                                <li><em>Good:</em> <code>//button[contains(., 'Clear')]</code> (Checks text content of
                                    element and children)</li>
                            </ul>
                        </li>
                        <li><strong>Mock Blocking functions:</strong> <code>window.alert</code> can block the execution
                            thread in headless mode. Overwrite it to prevent hangs if an error occurs.
                            <ul>
                                <li><em>Karate Example:</em> <code>* script("window.alert = function(){}")</code></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </section>

            <!-- SECTION 4: API KEYS (Was 11/3) -->
            <section id="api-keys" class="step-section">
                <div class="step-header">
                    <h2>4. Testing with Restricted API Keys</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">Handling referrer restrictions in automated tests.</div>
                    </div>
                </div>
                <div class="step-content">
                    <p><strong>Issue:</strong> Frontend API keys often have "Referrer Restrictions" (e.g., allow
                        <code>localhost:3000</code>).
                    </p>
                    <p><strong>Symptoms:</strong> Your API tests fail with a <strong>403 Forbidden</strong> status code.
                        The response body explicitly mentions restrictions:</p>
                    <pre><code class="language-json">{
  "error_message": "API keys with referer restrictions cannot be used with this API.",
  "status": "REQUEST_DENIED"
}</code></pre>
                    <ul>
                        <li><strong>Problem A:</strong> Direct API calls (backend-style) from tests lack the
                            <code>Referer</code> header.
                        </li>
                        <li><strong>Problem B:</strong> Some Google Web Services (Places/Directions Web Service)
                            strictly reject frontend keys regardless of headers.</li>
                    </ul>
                    <p><strong>Solutions:</strong></p>
                    <ul>
                        <li><strong>Add Headers:</strong> For permitted APIs, add the header in the test background:
                            <code>* header Referer = 'http://localhost:3000/'</code>.
                        </li>
                        <li><strong>Ignore Invalid Tests:</strong> If the key is strictly frontend-only, do not run
                            direct backend API tests. Use <code>@ignore</code> tags.</li>
                    </ul>
                </div>
            </section>

            <!-- PHASE 2: CLOUD SETUP -->

            <!-- SECTION 5: GCP SETUP (Was 2/6) -->
            <section id="gcp-setup" class="step-section">
                <div class="step-header">
                    <h2>5. Google Cloud Setup</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">Why? We need to tell Google Cloud to activate the specific services (APIs)
                            we plan to use, like IAM and Artifact Registry.</div>
                    </div>
                </div>
                <div class="step-content">
                    <p>Set up your environment variables to make copy-pasting easier.</p>
                    <div class="code-block">
                        <pre><code class="language-bash">export PROJECT_ID="your-project-id"
export REGION="us-central1"
export REPO_NAME="gcp-wif-demo"
export USER_NAME="your-github-username"</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>

                    <p>Enable the required APIs:</p>
                    <div class="code-block">
                        <pre><code class="language-bash">gcloud services enable iam.googleapis.com \
    cloudresourcemanager.googleapis.com \
    iamcredentials.googleapis.com \
    artifactregistry.googleapis.com \
    --project="${PROJECT_ID}"</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>
                </div>
            </section>

            <!-- SECTION 6: WIF (Was 3/7) -->
            <section id="wif" class="step-section">
                <div class="step-header">
                    <h2>6. Workload Identity Federation</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">Required because: This establishes a "trust relationship" so Google Cloud
                            believes GitHub is a legitimate identity provider. No keys needed!</div>
                    </div>
                </div>
                <div class="step-content">
                    <p>Create a <strong>Pool</strong> to organize your external identities.</p>
                    <div class="code-block">
                        <pre><code class="language-bash">gcloud iam workload-identity-pools create "github-pool" \
  --project="${PROJECT_ID}" \
  --location="global" \
  --display-name="GitHub Actions Pool"</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>

                    <div class="image-wrapper">
                        <img src="images/gcp_wif_pool_ui.png" alt="WIF Pool UI">
                    </div>

                    <p>Create a <strong>Provider</strong> to trust GitHub's OIDC tokens.</p>
                    <div class="code-block">
                        <pre><code class="language-bash">gcloud iam workload-identity-pools providers create-oidc "github-provider" \
  --project="${PROJECT_ID}" \
  --location="global" \
  --workload-identity-pool="github-pool" \
  --display-name="GitHub Provider" \
  --attribute-mapping="google.subject=assertion.sub,attribute.actor=assertion.actor,attribute.repository=assertion.repository" \
  --issuer-uri="https://token.actions.githubusercontent.com"</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>
                </div>
            </section>

            <!-- SECTION 7: IAM (Was 4/8) -->
            <section id="iam" class="step-section">
                <div class="step-header">
                    <h2>7. Service Account & IAM</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">Why? The "Service Account" is the actual GCP user that performs the work
                            (like pushing a docker image). We give GitHub permission to "act as" this user.</div>
                    </div>
                </div>
                <div class="step-content">
                    <p>Create the Service Account:</p>
                    <div class="code-block">
                        <pre><code class="language-bash">export SERVICE_ACCOUNT="github-actions-sa"

gcloud iam service-accounts create "${SERVICE_ACCOUNT}" \
  --project="${PROJECT_ID}" \
  --display-name="GitHub Actions Service Account"</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>

                    <p>Grant permission to write to Artifact Registry:</p>
                    <div class="code-block">
                        <pre><code class="language-bash">gcloud projects add-iam-policy-binding "${PROJECT_ID}" \
  --member="serviceAccount:${SERVICE_ACCOUNT}@${PROJECT_ID}.iam.gserviceaccount.com" \
  --role="roles/artifactregistry.writer"</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>

                    <p><strong>Crucial Step:</strong> Allow your specific GitHub repo to impersonate this Service
                        Account.
                    </p>
                    <div class="code-block">
                        <pre><code class="language-bash">gcloud iam service-accounts add-iam-policy-binding "${SERVICE_ACCOUNT}@${PROJECT_ID}.iam.gserviceaccount.com" \
  --project="${PROJECT_ID}" \
  --role="roles/iam.workloadIdentityUser" \
  --member="principalSet://iam.googleapis.com/projects/$(gcloud projects describe ${PROJECT_ID} --format='value(projectNumber)')/locations/global/workloadIdentityPools/github-pool/attribute.repository/${USER_NAME}/${REPO_NAME}"</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>
                </div>
            </section>

            <!-- SECTION 8: ARTIFACT REGISTRY (Was 5/9) -->
            <section id="artifact" class="step-section">
                <div class="step-header">
                    <h2>8. Artifact Registry</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">Why? We need a private, secure place to store our Docker container images,
                            similar to Docker Hub but inside Google Cloud.</div>
                    </div>
                </div>
                <div class="step-content">
                    <p>Create the Docker repository:</p>
                    <div class="code-block">
                        <pre><code class="language-bash">export AR_REPO="my-docker-repo"

gcloud artifacts repositories create "${AR_REPO}" \
  --project="${PROJECT_ID}" \
  --location="${REGION}" \
  --repository-format=docker \
  --description="Docker repository for GitHub Actions"</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>
                    <div class="image-wrapper">
                        <img src="images/gcp_artifact_registry_ui.png" alt="Artifact Registry UI">
                    </div>
                </div>
            </section>

            <!-- PHASE 3: CI/CD PIPELINE -->

            <!-- SECTION 9: DOCKER SECRETS (Was 8/11) -->
            <section id="docker-secrets" class="step-section">
                <div class="step-header">
                    <h2>9. Docker Build Arguments & Secrets</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">How to safely pass secrets during docker build.</div>
                    </div>
                </div>
                <div class="step-content">
                    <p><strong>Issue:</strong> Passing secrets as build arguments to <code>docker build</code> via shell
                        commands is prone to errors due to quoting and shell expansion.</p>
                    <p><strong>Symptoms:</strong> You might see obscure syntax errors in your build log like:</p>
                    <pre><code class="language-bash">docker: "build" requires 1 argument.
See 'docker build --help'.</code></pre>
                    <p>Or, if the build succeeds, your application crashes at runtime because the secret variable is
                        empty.</p>
                    <p><strong>Solution:</strong> Use the official <code>docker/build-push-action</code>. It handles
                        secret injection safely and correctly parses arguments.</p>
                    <div class="code-block">
                        <pre><code class="language-yaml">- name: Build App Image
  uses: docker/build-push-action@v5
  with:
    context: .
    load: true # Keeps image available for subsequent steps
    build-args: |
      REACT_APP_GOOGLE_API_KEY=${{ secrets.REACT_APP_GOOGLE_API_KEY }}</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>
                </div>
            </section>

            <!-- SECTION 10: JAVA VERSION (Was 10/4) -->
            <section id="java-compat" class="step-section">
                <div class="step-header">
                    <h2>10. Java Version Compatibility</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">Ensuring tools have the correct Java runtime.</div>
                    </div>
                </div>
                <div class="step-content">
                    <p><strong>Issue:</strong> Tools may have specific Java requirements that differ from the project
                        default. Karate 1.5.0+ requires Java 17, while the project might be on Java 11.</p>
                    <p><strong>Symptoms:</strong> The build fails immediately with a class version error:</p>
                    <pre><code>java.lang.UnsupportedClassVersionError: 
com/intuit/karate/Main has been compiled by a more recent version 
of the Java Runtime (class file version 61.0)...</code></pre>
                    <p><strong>Solution:</strong> Explicitly set the Java version in both the CI environment
                        (<code>actions/setup-java</code>) and the Maven configuration
                        (<code>maven-compiler-plugin</code>).</p>
                    <div class="code-block">
                        <pre><code class="language-yaml">- uses: actions/setup-java@v4
  with:
    java-version: '17'</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>
                </div>
            </section>

            <!-- SECTION 11: GITHUB ENVIRONMENTS (Was 9/12) -->
            <section id="github-env" class="step-section">
                <div class="step-header">
                    <h2>11. GitHub Environments</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">Accessing environment-specific secrets.</div>
                    </div>
                </div>
                <div class="step-content">
                    <p><strong>Issue:</strong> Secrets defined in a specific GitHub Environment (e.g., <code>CI</code>)
                        are not accessible to the workflow job unless the job explicitly references that environment.
                    </p>
                    <p><strong>Symptoms:</strong> Your workflow runs, but steps that need the secret fail. If you print
                        the secret (be careful!), it is empty. Your app logs might say:</p>
                    <pre><code>Error: GOOGLE_API_KEY is not set</code></pre>
                    <p><strong>Solution:</strong> Add the <code>environment</code> property to the job configuration.
                    </p>
                    <div class="code-block">
                        <pre><code class="language-yaml">jobs:
  test:
    environment: CI
    steps:
      ...</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>
                </div>
            </section>

            <!-- SECTION 12: ACTIONS (Was 6/10) -->
            <section id="actions" class="step-section">
                <div class="step-header">
                    <h2>12. GitHub Actions Workflow</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">Why? This YAML file tells GitHub *exactly* what steps to run automatically
                            when you push code.</div>
                    </div>
                </div>
                <div class="step-content">
                    <p>Create <code>.github/workflows/deploy.yaml</code> in your repo:</p>
                    <div class="code-block">
                        <pre><code class="language-yaml">name: Build and Push to GCP

on:
  push:
    branches: [ "main" ]

env:
  PROJECT_ID: 'your-project-id'
  REGION: 'us-central1'
  GAR_LOCATION: 'us-central1-docker.pkg.dev/your-project-id/my-docker-repo'
  SERVICE_ACCOUNT: 'github-actions-sa@your-project-id.iam.gserviceaccount.com'
  WORKLOAD_IDENTITY_PROVIDER: 'projects/123456789/locations/global/workloadIdentityPools/github-pool/providers/github-provider'

jobs:
  build-push:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write' # Required for WIF

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ env.WORKLOAD_IDENTITY_PROVIDER }}'
          service_account: '${{ env.SERVICE_ACCOUNT }}'

      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: Docker Auth
        run: |-
          gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Build and Push Container
        run: |-
          docker build -t "${{ env.GAR_LOCATION }}/my-app:${{ github.sha }}" .
          docker push "${{ env.GAR_LOCATION }}/my-app:${{ github.sha }}"</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>
                </div>
            </section>

            <!-- SECTION 13: CLOUD RUN (Was 7/13) -->
            <section id="cloudrun" class="step-section">
                <div class="step-header">
                    <h2>13. Deploy to Cloud Run</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">Why? Cloud Run is "serverless". It takes your Docker container and runs it
                            on a URL instantly without you managing servers.</div>
                    </div>
                </div>
                <div class="step-content">
                    <p>Update your workflow file to add the deploy step:</p>
                    <div class="code-block">
                        <pre><code class="language-yaml">      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: my-app-service
          region: ${{ env.REGION }}
          image: ${{ env.GAR_LOCATION }}/my-app:${{ github.sha }}
          flags: '--allow-unauthenticated'</code></pre>
                        <button class="copy-btn">Copy</button>
                    </div>
                    <p><strong>To Kick-start:</strong> Commit and push these changes to your <code>main</code> branch.
                        Go to the <strong>Actions</strong> tab in GitHub to watch it fly!</p>
                </div>
            </section>

            <!-- PHASE 4: ADVANCED -->

            <!-- SECTION 14: GCP SELF-HOSTED RUNNERS -->
            <section id="self-hosted" class="step-section">
                <div class="step-header">
                    <h2>14. GCP Self-Hosted Runners</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">Setting up and troubleshooting self-hosted GitHub Runners on GCP.</div>
                    </div>
                </div>
                <div class="step-content">
                    <p>A guide to setting up and troubleshooting self-hosted GitHub Runners on Google Cloud Platform.
                    </p>

                    <h3 style="color: var(--highlight-color); margin-top: 1rem; margin-bottom: 1rem;">Setup & Deployment
                    </h3>
                    <p><strong>Steps:</strong></p>
                    <ol>
                        <li><strong>Preparation</strong>: Install <code>gcloud</code> SDK and authenticate
                            (<code>gcloud auth login</code>).</li>
                        <li><strong>Note</strong>: Ensure you are authenticated before running deployment scripts!
                        </li>
                        <li><strong>Configuration</strong>: Create a <code>.env</code> file in <code>gcp-runner/</code>
                            to store your GitHub Personal Access Token (PAT).
                            <div class="code-block">
                                <pre><code class="language-bash"># gcp-runner/.env
GITHUB_PAT=ghp_your_token_here</code></pre>
                                <button class="copy-btn">Copy</button>
                            </div>
                        </li>
                        <li><strong>Deploy</strong>: Run the deployment script.
                            <div class="code-block">
                                <pre><code class="language-bash">cd gcp-runner
./deploy.sh</code></pre>
                                <button class="copy-btn">Copy</button>
                            </div>
                        </li>
                    </ol>

                    <h3 style="color: var(--highlight-color); margin-top: 2rem; margin-bottom: 1rem;">Updating Runners
                        (Lifecycle)</h3>
                    <p><strong>Crucial Lesson:</strong> Changes to <code>startup-script.sh</code> do
                        <strong>NOT</strong>
                        apply to running instances.
                    </p>
                    <p>To apply changes (e.g., installing new tools), you must <strong>Re-run the Deployment
                            Script</strong>.
                        The script handles the lifecycle:</p>
                    <ol>
                        <li>Deletes existing Managed Instance Groups (MIG).</li>
                        <li>Deletes old Instance Templates.</li>
                        <li>Creates a new Template with the updated script.</li>
                        <li>Creates a new MIG, provisioning fresh VMs.</li>
                    </ol>

                    <h3 style="color: var(--highlight-color); margin-top: 2rem; margin-bottom: 1rem;">Optimization:
                        Golden Image Strategy</h3>
                    <p><strong>Problem:</strong> Standard runners fail to start in < 5 minutes because they install
                            Docker/Git on every boot.</p>
                            <p><strong>Solution:</strong> The "Golden Image" strategy builds a custom disk image with
                                all dependencies pre-installed. This moves the heavy lifting to the <em>build</em>
                                phase.</p>

                            <h4 style="margin-top: 1rem;">1. Image Setup Script (setup-image.sh)</h4>
                            <p>Installs dependencies on a temporary VM.</p>
                            <div class="code-block">
                                <pre><code class="language-bash">#!/bin/bash
set -e
# Install Docker, Git, jq, curl
apt-get update && apt-get install -y docker.io git jq curl wget

# Pre-pull Docker images to speed up CI
systemctl start docker
docker pull node:20-alpine

# Install GitHub Runner (but don't configure yet)
mkdir -p /actions-runner && cd /actions-runner
curl -o runner.tar.gz -L https://github.com/actions/runner/releases/download/v2.311.0/actions-runner-linux-x64-2.311.0.tar.gz
tar xzf runner.tar.gz
./bin/installdependencies.sh

# Cleanup unique IDs so they don't persist in the image
truncate -s 0 /etc/machine-id</code></pre>
                                <button class="copy-btn">Copy</button>
                            </div>

                            <h4 style="margin-top: 1rem;">2. Build Image Script (build-image.sh)</h4>
                            <p>Creates the reusable disk image.</p>
                            <div class="code-block">
                                <pre><code class="language-bash"># Create temp VM
gcloud compute instances create builder-vm \
    --metadata-from-file=startup-script=./setup-image.sh \
    --image-family=ubuntu-2204-lts ...

# Wait for setup to finish...
sleep 300

# Create Image from Disk
gcloud compute images create gh-runner-golden-v1 --source-disk=builder-vm ...</code></pre>
                                <button class="copy-btn">Copy</button>
                            </div>

                            <p><strong>Deploying:</strong> Update your <code>deploy.sh</code> to use
                                <code>--image-family=gh-runner-image</code> instead of Ubuntu, and use a lightweight
                                <code>startup-script.sh</code> that only handles registration.
                            </p>

                            <h3 style="color: var(--highlight-color); margin-top: 2rem; margin-bottom: 1rem;">Common
                                Errors</h3>

                            <details class="faq-item">
                                <summary><strong>1. Invalid value for field 'resource.instanceTemplate'</strong>
                                </summary>
                                <div class="faq-body">
                                    <p><strong>Scenario:</strong> You run <code>deploy.sh</code> and it fails when
                                        creating the Managed Instance Group (MIG).</p>
                                    <p><strong>Error:</strong>
                                        <code>Invalid value for field 'resource.instanceTemplate': '...' does not exist.</code>
                                    </p>
                                    <p><strong>Cause:</strong> You created a "Regional" instance template, but the MIG
                                        is trying to find it globally (or vice versa). By default, `gcloud` might
                                        default to regional templates which are harder to reference across zones.</p>
                                    <p><strong>Fix:</strong> create the Instance Template as <strong>Global</strong>.
                                        Remove the <code>--region</code> flag from the `gcloud compute
                                        instance-templates create` command.</p>
                                </div>
                            </details>

                            <details class="faq-item">
                                <summary><strong>2. Push cannot contain secrets</strong></summary>
                                <div class="faq-body">
                                    <p><strong>Scenario:</strong> You try to `git push` your code, but the operation is
                                        rejected.</p>
                                    <p><strong>Cause:</strong> You accidentally committed your `gcp-key.json` or
                                        hardcoded a PAT in a script. GitHub's secret scanning (or pre-commit hooks)
                                        blocked it to protect you.</p>
                                    <p><strong>Fix:</strong> Remove the file/secret. You might need to use `git reset
                                        HEAD~1` to undo the commit, then modify the file to use environment variables
                                        (`$GITHUB_PAT`), and commit again.</p>
                                </div>
                            </details>

                            <details class="faq-item">
                                <summary><strong>3. ENOSPC: no space left on device</strong></summary>
                                <div class="faq-body">
                                    <p><strong>Scenario:</strong> The build fails while pulling Docker images.</p>
                                    <p><strong>Cause:</strong> The default disk size for some machine types is small
                                        (e.g., 10-30GB). Docker images and layers accumulate quickly.</p>
                                    <p><strong>Fix:</strong> In <code>deploy.sh</code>, ensure the boot disk size is set
                                        to at least <strong>100GB</strong>: ` --boot-disk-size=100GB`.</p>
                                </div>
                            </details>

                            <details class="faq-item">
                                <summary><strong>4. The resource ... already exists</strong></summary>
                                <div class="faq-body">
                                    <p><strong>Scenario:</strong> You run <code>deploy.sh</code> a second time time to
                                        update something, and it crashes.</p>
                                    <p><strong>Cause:</strong> The script is trying to create resources (MIG, Template)
                                        that already exist. It doesn't know how to "update".</p>
                                    <p><strong>Fix:</strong> Add cleanup logic to the top of your script. Check if the
                                        resource exists, and `delete` it before `create`. (See Reference Scripts).</p>
                                </div>
                            </details>

                            <details class="faq-item">
                                <summary><strong>5. Could not fetch image resource</strong></summary>
                                <div class="faq-body">
                                    <p><strong>Scenario:</strong> The deployment fails saying the Image was not found.
                                    </p>
                                    <p><strong>Cause:</strong> You likely referenced a specific image version (e.g.,
                                        `ubuntu-2204-v20240101`) that Google has since deprecated and deleted.</p>
                                    <p><strong>Fix:</strong> Always use the <strong>Image Family</strong> flag:
                                        `--image-family=ubuntu-2204-lts`. This points to the latest available version
                                        automatically.</p>
                                </div>
                            </details>

                            <details class="faq-item">
                                <summary><strong>6. bash: ./deploy.sh: Permission denied</strong></summary>
                                <div class="faq-body">
                                    <p><strong>Scenario:</strong> You try to run the script and the terminal says
                                        "Permission denied".</p>
                                    <p><strong>Cause:</strong> The file does not have the "Execute" permission bit set
                                        on the filesystem.</p>
                                    <p><strong>Fix:</strong> Run <code>chmod +x deploy.sh startup-script.sh</code> to
                                        make them executable.</p>
                                </div>
                            </details>

                            <details class="faq-item">
                                <summary><strong>7. Slow Performance / Queuing</strong></summary>
                                <div class="faq-body">
                                    <p><strong>Scenario:</strong> You start a workflow. It stays "Queued" for 4 minutes
                                        before starting. The run is slow.</p>
                                    <p><strong>Cause:</strong> If you use Ephemeral runners without an idle pool, every
                                        job has to boot a whole new VM, install Docker, and register. This takes time.
                                    </p>
                                    <p><strong>Fix:</strong> Use the "Idle Timeout" strategy. Keep the runner alive for
                                        10 minutes after a job so subsequent jobs are instant. Also, increase MIG size.
                                    </p>
                                </div>
                            </details>

                            <details class="faq-item">
                                <summary><strong>8. gh: command not found</strong></summary>
                                <div class="faq-body">
                                    <p><strong>Scenario:</strong> Your workflow uses `gh release create`, but it fails
                                        on the self-hosted runner.</p>
                                    <p><strong>Cause:</strong> The `gh` CLI tool comes pre-installed on GitHub-hosted
                                        runners, but NOT on standard Ubuntu images. Your runner is "naked".</p>
                                    <p><strong>Fix:</strong> Add the installation steps for `gh` CLI to your
                                        <code>startup-script.sh</code>.</p>
                                </div>
                            </details>

                            <details class="faq-item">
                                <summary><strong>9. Deployment Script Hanging</strong></summary>
                                <div class="faq-body">
                                    <p><strong>Scenario:</strong> You run <code>deploy.sh</code>. It prints "Cleaning
                                        up..." and then sits there forever. Ctrl+C is required.</p>
                                    <p><strong>Cause:</strong> <code>gcloud</code> is trying to ask for a confirmation
                                        or password, but you piped the output to `&>/dev/null` (or it's hidden), so you
                                        can't see the prompt.</p>
                                    <p><strong>Fix:</strong> Remove `&>/dev/null` from your commands while debugging.
                                        Add explicit authentication checks at the top of the script.</p>
                                </div>
                            </details>

                            <details class="faq-item">
                                <summary><strong>10. CI Failure: "mvn: command not found"</strong></summary>
                                <div class="faq-body">
                                    <p><strong>Cause:</strong> Similar to `gh` CLI, Maven is not installed by default on
                                        Ubuntu.</p>
                                    <p><strong>Fix:</strong> Add <code>apt-get install -y maven</code> to your startup
                                        script.</p>
                                </div>
                            </details>

                            <details class="faq-item">
                                <summary><strong>11. CI Failure: "driver config / start failed"</strong></summary>
                                <div class="faq-body">
                                    <p><strong>Scenario:</strong> Your UI tests fail with "Chrome not reachable" or
                                        "Driver failed".</p>
                                    <p><strong>Cause:</strong> You are trying to run Headless Chrome, but Chrome isn't
                                        even installed on the runner VM.</p>
                                    <p><strong>Fix:</strong> Add the Google Chrome stable installation block to your
                                        startup script.</p>
                                </div>
                            </details>

                            <details class="faq-item">
                                <summary><strong>12. Golden Image Build Hangs</strong></summary>
                                <div class="faq-body">
                                    <p><strong>Scenario:</strong> You try to build a Golden Image. The script runs for
                                        hours and never finishes.</p>
                                    <p><strong>Cause:</strong> `apt-get install` commands often stop to ask "Do you want
                                        to restart services?". Since there is no user to say "Yes", it waits forever.
                                    </p>
                                    <p><strong>Fix:</strong> Set the environment variable
                                        `DEBIAN_FRONTEND=noninteractive` before running apt commands in your setup
                                        script.</p>
                                </div>
                            </details>

                            <details class="faq-item">
                                <summary><strong>13. Runners Stuck / Queueing Indefinitely</strong></summary>
                                <div class="faq-body">
                                    <p><strong>Scenario:</strong> GitHub shows "Queued" for 20 minutes. You check GCP,
                                        and the VMs are running.</p>
                                    <p><strong>Cause A (Labels):</strong> Your workflow demands `runs-on: [self-hosted,
                                        linux]`, but your runner registered with `labels: gcp-runner`. They must match.
                                    </p>
                                    <p><strong>Cause B (Broken Startup):</strong> The startup script crashed before
                                        registering. Check the VM logs (Serial Port 1 observations) in GCP Console.</p>
                                    <p><strong>Fix:</strong> Ensure `labels` in `config.sh` match the workflow. Check
                                        logs for script errors.</p>
                                </div>
                            </details>

                            <h3 style="color: var(--highlight-color); margin-top: 2rem; margin-bottom: 1rem;">Reference
                                Scripts
                            </h3>

                            <details class="faq-item">
                                <summary><strong>deploy.sh</strong> (Click to Expand)</summary>
                                <div class="code-block">
                                    <pre><code class="language-bash">#!/bin/bash
# Deploy GCP GitHub Runner Infrastructure (Standard Tier + Persistence)

# Configuration
PROJECT_ID=$(gcloud config get-value project)
REGION="us-central1"
ZONE="us-central1-a"
TEMPLATE_NAME="gh-runner-template"
MIG_NAME="gh-runner-mig"
REPO_OWNER="&lt;YOUR_GITHUB_USERNAME&gt;"
REPO_NAME="&lt;YOUR_REPO_NAME&gt;"

# Load from .env if it exists
if [ -f .env ]; then
    export $(cat .env | xargs)
fi

# Check if GITHUB_PAT is set, otherwise prompt
if [ -z "$GITHUB_PAT" ]; then
    read -s -p "Enter GitHub PAT: " GITHUB_PAT
    echo ""
fi

# Explicit Auth Check
if ! gcloud auth print-access-token &>/dev/null; then
    echo "Error: gcloud not authenticated. Run 'gcloud auth login' first."
    exit 1
fi

echo "Deploying to Project: $PROJECT_ID"

# 0. Cleanup Existing Resources (to allow upgrades/re-runs)
echo "Cleaning up existing resources..."
# Delete MIG if it exists
if gcloud compute instance-groups managed describe $MIG_NAME --zone=$ZONE --project=$PROJECT_ID &>/dev/null; then
    echo "Deleting existing MIG: $MIG_NAME"
    gcloud compute instance-groups managed delete $MIG_NAME --zone=$ZONE --project=$PROJECT_ID --quiet
fi

# Delete Instance Template if it exists (Global)
if gcloud compute instance-templates describe $TEMPLATE_NAME --project=$PROJECT_ID &>/dev/null; then
    echo "Deleting existing Instance Template: $TEMPLATE_NAME"
    gcloud compute instance-templates delete $TEMPLATE_NAME --project=$PROJECT_ID --quiet
fi

# 1. Create Instance Template
echo "Creating Instance Template..."
gcloud compute instance-templates create $TEMPLATE_NAME \
    --project=$PROJECT_ID \
    --machine-type=e2-standard-4 \
    --network-interface=network-tier=PREMIUM,network=default,address= \
    --metadata-from-file=startup-script=./startup-script.sh \
    --metadata=github_pat=$GITHUB_PAT \
    --maintenance-policy=MIGRATE \
    --provisioning-model=STANDARD \
    --service-account=default \
    --scopes=https://www.googleapis.com/auth/devstorage.read_only,https://www.googleapis.com/auth/logging.write,https://www.googleapis.com/auth/monitoring.write,https://www.googleapis.com/auth/servicecontrol,https://www.googleapis.com/auth/service.management.readonly,https://www.googleapis.com/auth/trace.append \
    --tags=http-server,https-server \
    --image-family=ubuntu-2204-lts \
    --image-project=ubuntu-os-cloud \
    --boot-disk-size=100GB \
    --boot-disk-type=pd-balanced \
    --boot-disk-device-name=$TEMPLATE_NAME

# 2. Create Managed Instance Group (MIG)
echo "Creating Managed Instance Group..."
gcloud compute instance-groups managed create $MIG_NAME \
    --project=$PROJECT_ID \
    --base-instance-name=gh-runner \
    --template=$TEMPLATE_NAME \
    --size=2 \
    --zone=$ZONE

echo "Deployment Complete."</code></pre>
                                    <button class="copy-btn">Copy</button>
                                </div>
                            </details>

                            <details class="faq-item">
                                <summary><strong>startup-script.sh</strong> (Click to Expand)</summary>
                                <div class="code-block">
                                    <pre><code class="language-bash">#!/bin/bash
# GCP GitHub Runner Startup Script
# Optimized for e2-standard-4 (4 vCPU, 16 GB RAM) with Idle Timeout

set -e

# --- 1. Swap Configuration ---
echo "Setting up Swap..."
# Create 4GB swap file
fallocate -l 4G /swapfile || dd if=/dev/zero of=/swapfile bs=1M count=4096
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile
echo '/swapfile none swap sw 0 0' >> /etc/fstab
sysctl vm.swappiness=60
echo 'vm.swappiness=60' >> /etc/sysctl.conf

# --- 2. Install Dependencies ---
echo "Installing Docker, Git, Maven, and GitHub CLI..."
apt-get update
apt-get install -y docker.io git jq curl maven

# Install Google Chrome (for UI Tests)
echo "Installing Google Chrome..."
wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -
echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list
apt-get update
apt-get install -y google-chrome-stable

# Install gh CLI
mkdir -p -m 755 /etc/apt/keyrings
wget -qO- https://cli.github.com/packages/githubcli-archive-keyring.gpg | tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null
chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
apt-get update
apt-get install -y gh

systemctl enable --now docker

# --- 3. Install GitHub Runner ---
echo "Installing GitHub Runner..."
mkdir /actions-runner && cd /actions-runner
curl -o actions-runner-linux-x64-2.311.0.tar.gz -L https://github.com/actions/runner/releases/download/v2.311.0/actions-runner-linux-x64-2.311.0.tar.gz
tar xzf ./actions-runner-linux-x64-2.311.0.tar.gz

# --- 4. Configuration Variables ---
GITHUB_REPO="&lt;YOUR_GITHUB_USERNAME&gt;/&lt;YOUR_REPO_NAME&gt;"
REPO_URL="https://github.com/${GITHUB_REPO}"
# PAT fetched from Instance Metadata
PAT=$(curl -s -H "Metadata-Flavor: Google" "http://metadata.google.internal/computeMetadata/v1/instance/attributes/github_pat")

if [ -z "$PAT" ]; then
  echo "Error: github_pat metadata not found."
  exit 1
fi

# --- 5. Get Registration Token ---
echo "Fetching Registration Token..."
REG_TOKEN=$(curl -s -X POST -H "Authorization: token ${PAT}" -H "Accept: application/vnd.github.v3+json" https://api.github.com/repos/${GITHUB_REPO}/actions/runners/registration-token | jq -r .token)

if [ "$REG_TOKEN" == "null" ]; then
    echo "Failed to get registration token. Check PAT permissions."
    exit 1
fi

# --- 6. Configure & Run (Persistent with Idle Timeout) ---
echo "Configuring Runner..."
export RUNNER_ALLOW_RUNASROOT=1
./config.sh --url ${REPO_URL} --token ${REG_TOKEN} --unattended --name "$(hostname)" --labels "gcp-micro"

echo "Installing Runner as Service..."
./svc.sh install
./svc.sh start

# --- 7. Idle Shutdown Monitor ---
# Monitor for 'Runner.Worker' process which indicates an active job.
# If no job runs for IDLE_TIMEOUT seconds, shut down.
IDLE_TIMEOUT=600 # 10 minutes
CHECK_INTERVAL=30
IDLE_TIMER=0

echo "Starting Idle Monitor (Timeout: ${IDLE_TIMEOUT}s)..."

while true; do
  sleep $CHECK_INTERVAL
  
  # Check if Runner.Worker is running (indicates active job)
  if pgrep -f "Runner.Worker" > /dev/null; then
    echo "Job in progress. Resetting idle timer."
    IDLE_TIMER=0
  else
    IDLE_TIMER=$((IDLE_TIMER + CHECK_INTERVAL))
    echo "Runner idle for ${IDLE_TIMER}s..."
  fi

  if [ $IDLE_TIMER -ge $IDLE_TIMEOUT ]; then
    echo "Idle timeout reached (${IDLE_TIMEOUT}s). Shutting down..."
    shutdown -h now
    break
  fi
done</code></pre>
                                    <button class="copy-btn">Copy</button>
                                </div>
                            </details>
                </div>
            </section>

            <!-- APPENDIX: TROUBLESHOOTING -->
            <section id="troubleshoot" class="step-section">
                <div class="step-header">
                    <h2>15. Top 10 Common Errors</h2>
                    <div class="tooltip-container">
                        <span class="info-icon">?</span>
                        <div class="tooltip">First deployments fail 90% of the time due to permission logic. Here is how
                            to
                            fix the most common ones.</div>
                    </div>
                </div>
                <div class="step-content">
                    <h3 style="color: var(--highlight-color); margin-top: 1rem; margin-bottom: 1rem;">Deployment & CI/CD
                        Errors</h3>

                    <details class="faq-item">
                        <summary><strong>1. Container failed to start (App Code)</strong></summary>
                        <div class="faq-body">
                            <p><strong>Error Log:</strong>
                                <code>Cloud Run error: Container failed to start. Failed to start and then listen on the port defined by the PORT environment variable.</code>
                            </p>
                            <p><strong>Cause:</strong> Cloud Run injects a random port (e.g., 8080) into the `$PORT` env
                                var. Your code is likely hardcoded to port 3000, so it never "picks up the phone".</p>
                            <p><strong>Fix:</strong> Update <code>server.js</code> or <code>vite.config.js</code> to use
                                <code>process.env.PORT || 3000</code>.</p>
                        </div>
                    </details>

                    <details class="faq-item">
                        <summary><strong>2. Reserved Env Var 'PORT' (Deployment Config)</strong></summary>
                        <div class="faq-body">
                            <p><strong>Error Log:</strong>
                                <code>The following reserved env names were provided: PORT. These values are automatically set by the system.</code>
                            </p>
                            <p><strong>Cause:</strong> You are trying to be helpful by manually creating a `PORT`
                                environment variable in your GitHub Actions workflow or Cloud Run config. Google forbids
                                this because *they* control the port.</p>
                            <p><strong>Fix:</strong> Delete the <code>PORT</code> variable from your <code>env:</code>
                                block in the YAML file.</p>
                        </div>
                    </details>

                    <details class="faq-item">
                        <summary><strong>3. Artifact Registry Repo Not Found</strong></summary>
                        <div class="faq-body">
                            <p><strong>Error Log:</strong> <code>name unknown: Repository "..." not found</code></p>
                            <p><strong>Cause:</strong> The Docker Push step is trying to upload to a repository that
                                doesn't exist yet.</p>
                            <p><strong>Fix:</strong> Run the one-time manual setup command:
                                <code>gcloud artifacts repositories create ...</code> (See Phase 2).</p>
                        </div>
                    </details>

                    <details class="faq-item">
                        <summary><strong>4. Permission 'run.admin' missing</strong></summary>
                        <div class="faq-body">
                            <p><strong>Error Log:</strong>
                                <code>PERMISSION_DENIED: The caller does not have permission</code> during the deploy
                                step.</p>
                            <p><strong>Cause:</strong> The Service Account you created (which GitHub uses) has
                                permission to *push* to the registry, but NOT to *deploy* to Cloud Run. They are
                                separate roles.</p>
                            <p><strong>Fix:</strong> Grant the <code>roles/run.admin</code> role to the Service Account.
                            </p>
                        </div>
                    </details>

                    <details class="faq-item">
                        <summary><strong>5. Permission 'iam.serviceAccountUser' missing</strong></summary>
                        <div class="faq-body">
                            <p><strong>Scenario:</strong> The deploy step fails with a cryptic permission error, even
                                though you have <code>run.admin</code>.</p>
                            <p><strong>Cause:</strong> To deploy a service, the deployer (GitHub) must be allowed to
                                "Act As" the service identity that will run the app. This is a security check.</p>
                            <p><strong>Fix:</strong> Grant <code>roles/iam.serviceAccountUser</code> to the Service
                                Account *on itself* (or project-wide).</p>
                        </div>
                    </details>

                    <details class="faq-item">
                        <summary><strong>6. Subject Issuer Mismatch</strong></summary>
                        <div class="faq-body">
                            <p><strong>Error Log:</strong> <code>Subject [...] does not match principalSet [...]</code>
                            </p>
                            <p><strong>Cause:</strong> The Workload Identity Federation trust rule expects a specific
                                repo name (e.g., `Joy/App`), but the token is coming from (`Joy/app`). It is
                                case-sensitive!</p>
                            <p><strong>Fix:</strong> Re-run the `add-iam-policy-binding` command ensuring the casing
                                matches your GitHub repo exactly.</p>
                        </div>
                    </details>

                    <details class="faq-item">
                        <summary><strong>7. Permission 'artifactregistry.writer' missing</strong></summary>
                        <div class="faq-body">
                            <p><strong>Scenario:</strong> <code>docker push</code> fails with "Denied".</p>
                            <p><strong>Cause:</strong> Service Account lacks write access to the registry.</p>
                            <p><strong>Fix:</strong> Grant <code>roles/artifactregistry.writer</code>.</p>
                        </div>
                    </details>

                    <details class="faq-item">
                        <summary><strong>8. Org Policy Restricted</strong></summary>
                        <div class="faq-body">
                            <p><strong>Scenario:</strong> You deploy successfully, but the URL is unreachable or 403.
                                You see "Organization Policy restricted" in logs.</p>
                            <p><strong>Cause:</strong> Your corporate Google Cloud setup forbids "AllUsers" (public
                                internet) from accessing Cloud Run services.</p>
                            <p><strong>Fix:</strong> Remove <code>--allow-unauthenticated</code> from the deploy flags,
                                or ask your Org Admin to create an exception.</p>
                        </div>
                    </details>

                    <details class="faq-item">
                        <summary><strong>9. Region Mismatch</strong></summary>
                        <div class="faq-body">
                            <p><strong>Error Log:</strong> <code>Image not found</code> or
                                <code>Manifest not found</code>.</p>
                            <p><strong>Cause:</strong> You pushed your image to a registry in `us-east1` (in Step 1),
                                but you are trying to deploy to a Cloud Run service in `us-central1` (Step 2). They
                                can't see each other easily.</p>
                            <p><strong>Fix:</strong> Ensure the `REGION` variable is consistent across all steps.</p>
                        </div>
                    </details>

                    <details class="faq-item">
                        <summary><strong>10. Cloud Run Admin API Disabled</strong></summary>
                        <div class="faq-body">
                            <p><strong>Error Log:</strong>
                                <code>Cloud Run Admin API has not been used in project ... or it is disabled.</code></p>
                            <p><strong>Cause:</strong> You created a project but didn't turn on the "Cloud Run" feature
                                explicitly.</p>
                            <p><strong>Fix:</strong> Run <code>gcloud services enable run.googleapis.com</code>.</p>
                        </div>
                    </details>

                    <details class="faq-item">
                        <summary><strong>11. GitHub Secrets Typos</strong></summary>
                        <div class="faq-body">
                            <p><strong>Scenario:</strong> Authentication fails. "Invalid Credentials".</p>
                            <p><strong>Tip:</strong> When you copy-paste from a terminal or webpage into GitHub Secrets
                                UI, you often capture a trailing newline or space. GitHub doesn't trim this
                                automatically for all secret types.</p>
                        </div>
                    </details>

                    <details class="faq-item">
                        <summary><strong>12. Docker Context Error</strong></summary>
                        <div class="faq-body">
                            <p><strong>Scenario:</strong> <code>COPY . .</code> fails to copy files, or the build is
                                missing files.</p>
                            <p><strong>Cause:</strong> You have a <code>.dockerignore</code> file that is too
                                aggressive, filtering out the source code you want to build.</p>
                        </div>
                    </details>

                    <details class="faq-item">
                        <summary><strong>13. Resource not accessible (403)</strong></summary>
                        <div class="faq-body">
                            <p><strong>Error Log:</strong> <code>HTTP 403: Resource not accessible by integration</code>
                            </p>
                            <p><strong>Cause:</strong> The default ephemeral `GITHUB_TOKEN` used by Actions often has
                                "Read Only" permissions by default in new organizations.</p>
                            <p><strong>Fix:</strong> Use a Personal Access Token (PAT) stored in secrets that has the
                                `repo` scope, or update the "Workflow permissions" in Repo Settings to "Read and Write".
                            </p>
                        </div>
                    </details>

                    <details class="faq-item">
                        <summary><strong>14. High Severity Vulnerabilities (npm audit)</strong></summary>
                        <div class="faq-body">
                            <p><strong>Issue:</strong> Nested dependencies (e.g. <code>nth-check</code>) having
                                vulnerabilities.</p>
                            <p><strong>Fix:</strong> Use <code>overrides</code> in <code>package.json</code> to force
                                secure versions.</p>
                        </div>
                    </details>

                    <details class="faq-item">
                        <summary><strong>15. Runners Not Connecting (Golden Image Failure)</strong></summary>
                        <div class="faq-body">
                            <p><strong>Symptoms:</strong> Deployment succeeds, but runners never appear in GitHub.</p>
                            <p><strong>Cause:</strong> <code>setup-image.sh</code> failed during image creation. The
                                runner boots from a broken image.</p>
                            <p><strong>Fix:</strong> Check builder VM serial logs. Rebuild image if setup script
                                changes.</p>
                        </div>
                    </details>

                    <details class="faq-item">
                        <summary><strong>16. gcloud: command not found</strong></summary>
                        <div class="faq-body">
                            <p><strong>Cause:</strong> <code>gcloud</code> is not in the system <code>$PATH</code>
                                (common if installed locally).</p>
                            <p><strong>Fix:</strong> Update scripts to detect local binary:
                                <code>if [ -f "./google-cloud-sdk/bin/gcloud" ]; then ...</code></p>
                        </div>
                    </details>

                    <details class="faq-item">
                        <summary><strong>17. Offline Listing Clutter</strong></summary>
                        <div class="faq-body">
                            <p><strong>Cause:</strong> Runners destroyed without deregistration.</p>
                            <p><strong>Fix:</strong> Use <code>--ephemeral</code> flag in <code>config.sh</code> so
                                GitHub auto-removes them after one job.</p>
                        </div>
                    </details>
                </div>
            </section>

        </main>

        <footer>
            <p>&copy; 2024 Secure CI/CD Guide. Generated by Antigravity.</p>
        </footer>
    </div>

    <script src="script.js"></script>
</body>

</html>